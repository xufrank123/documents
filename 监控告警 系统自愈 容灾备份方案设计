监控告警 系统自愈 容灾备份
目录
•	设计目标与原则
•	监控告警
•	系统自愈
•	容灾备份
•	三者联动
•	实施计划
•	具体落地
•	资源需求
•	技术选型

 

1.	设计目标与原则
1.1	目标：
可见性	全方位、实时监控系统状态
主动性	主动预防与自动修复,避免“被动救火”
系统韧性	系统可自动隔离、切换、恢复,保证业务连续性
可恢复性	故障恢复时间(MTTR)最小化
1.2	原则：
分层次	分层进行监控与防护：
基础设施
平台
应用服务
业务逻辑
用户体验
自动化	重复性的、可预判的任务尽可能自动化
形成闭环	监控->告警->诊断->自愈/恢复->验证->反馈优化
预案设计	应对任何可能的故障，既可人工(初期阶段以人工为主)，也可自动化

2.	监控告警
2.1分层监控
层级	监控对象	关键指标	告警策略
基础设施	服务器
网络	CPU/内存利用率、磁盘I/O、网络流量/丢包、CPU温度	阈值告警：
例如CPU占用率持续5分钟高达85%
突变告警
平台	中间件、数据库、K3S	连接数、QPS、慢查询、线程池、Pod状态、资源配额	黄金指标(流量、错误、延迟、饱和度)，
依赖拓扑关联告警
应用服务	微服务	接口响应时间、错误码(4xx/5xx)、JVM GC、业务日志错误	SLA/SLO驱动告警(如错误率>0.1%,基于燃烧率告警)
链路追踪
用户体验	前端	重点项：页面加载时间、Apdex分数
非重点项：CDN质量、地域访问差异	合成监控与
真实用户监控(RUM——页面加载性能、用户交互性能、错误收集、用户流分析
)结合
			
	分级告警: P0(致命)、P1(严重)、P2(警告)、P3(提示)
	降噪与聚合: 利用告警分组、抑制、降噪规则，避免“告警风暴”
	可操作性: 告警信息必须包含：发生了什,在哪儿发生,可能原因,
      相关日志/指标链接、建议处理动作。

3.系统自愈
场景	触发条件	自愈动作	恢复验证
实例/节点故障	1.机器ping不通
2.Agent失联
3.健康检查连续失败	1.负载均衡，隔离故障节点
2.K3S自动重建实例
3.告警通知	新实例通过健康检查后自动挂载，业务流量恢复
应用僵死/OOM	进程存在但无响应、HTTP探针超时、OOM日志(JVM快照)	1.抓取堆栈信息
2.自动重启容器
3.触发扩容	重启后指标是否恢复正常
依赖服务异常	下游服务超时率高、数据库连接失败	1.启动备用降级策略（如返回缓存、默认值）
2.触发熔断器，避免级联故障
3.隔离故障实例	持续探测下游服务，恢复后关闭熔断
资源瓶颈			
配置回滚	如果配置错误并与代码无关，应快速回滚到上一个版本	快速回滚
	


4.容灾(DR)与备份(Backup)
备份策略	备份类型	容灾架构
1. 一份生产,两份以上备份
2. 异地备份（比如A区数据库从库备份）	1. 全量+增量/差异备份，全量备份一周一次，增量备份一天一次
2. 逻辑备份(如mysqldump)与快照备份结合	同城多区部署实现高可用（比如Mysql多区部署读写分离）
故障切换流程：故障检测-决策裁定-数据同步-流量切换(DNS切换流量)-服务器启动与验证-通告与记录
		


5.监控告警，系统自愈，灾备三者联动：
日常运行	1.异常指标监控
2.告警触发自愈
3.自愈成功，关闭告警
重大故障	1.大面积基础性故障（比如整个区域宕机）
2.告警升级为P0
3.无法自愈？是，启动容灾流程
4.切换流量至灾备站点，监控站点业务健康度
数据灾难	1.监控/或人工检测到数据误操作(误删，误改)
2.启动备份流程，从备份数据中还原数据
3.恢复完成后，监控业务健康性

6.实施计划
第一阶段快速落地	指标抓取+可视化展示
系统自愈(无状态部署应用自动为主)
灾备(MySQL主从复制)
第二阶段完善体系	完善告警机制，完善系统自愈（将Mysql Redis，消息中间件等也加入到自愈体制）
第三阶段持续优化演进	灾备能力持续演进：异地灾备(热备为主，也考虑冷备和温备)，定期灾备演练

7.具体落地
监控告警	接入Prometheus+ Grafana + Alertmanager
系统自愈	K3S无状态部署应用自带pod副本，有状态部署(如对Mysql合理设置存活和就绪探针)
容灾备份	Mysql主从复制：从shardingjdbc过渡到mycat再过渡到异地热备

8.资源需求：
区域	资源	必须/可选
C区	虚拟机x3	必须
A区	虚拟机x2	可选

9.技术选型
组件	说明
Prometheus	抓取指标数据
Grafana	指标数据可视化
Alertmanager	告警策略，邮件提醒
K3S	应用部署,集群管理
ShardingJDBC/Mycat	数据库分片，数据库读写分离
Mysqldump+开启binlog日志	数据库全量备份+差异备份

注：
概念		说明	举例
SLA	服务等级协议	
SLO	服务等级目标，为SLI设定的目标	如99.99%的请求延迟<500ms
SLI	服务等级指标，选择衡量稳定性的指标	如成功率 延迟 可用性
Error Budget	错误预算	故障配额=1-99.99%;告警的核心逻辑应该基于错误配额的消耗速度
Burn Rate	燃烧率，错误预算消耗速率	比如：燃烧率==1指错误预算将在SLO周期结束时刚好用完
Apdex分数	Application performance Index； Apdex分数 = (满意次数+0.5*容忍次数)/总请求数；
分数越高表示服务越健康	响应时间<=T(阈值)表示满意，T< 响应时间 <=4T 表示能容忍，响应时间>4T表示失望
真实用户监控(RUM)	页面加载性能、用户交互性能、错误收集、用户流分析	
Kubernetes有状态部署	无状态部署和有状态部署对应不同的核心控制器
StatefulSet
	Mysql Redis 消息中间件等需要数据挂载的应用，需要做有状态部署防止数据丢失
Kubernetes无状态部署	无状态部署和有状态部署对应不同的核心控制器
Deployment	Account Service, Authenticate Service，Gateway,Data service等业务服务可以无状态部署 
资源配额	限制和保证一个命名空间或项目中可使用的计算资源总量，例如K8s中的ResourceQuota用于管理所有namespace的资源：requests.cpu所需cpu的下限limits.cpu所需cpu的上限、requests.memory内存下限、limits.memory内存上限 	每个容器限定内存/CPU上限
Mysqldump	MySQL官方的逻辑备份工具，讲数据转换成sql语句如create table…, insert into [table]…	
RTO	Recovery Time Objective(回复时间目标),从故障发生到业务恢复所允许的最大故障时间 	如果RTO==2h,意味着我必须在2h内让业务重新上线
RPO	Recovery Point Objective(恢复点目标)指故障发生时，企业能够忍受的最大数据丢失量，以时间为单位	RPO 决定了你需要“往回跳”多远来找回数据。如果 RPO 是 1 小时，意味着你最多能接受丢失过去 1 小时内产生的数据

 

参考https://github.com/milanm/DevOps-Roadmap?tab=readme-ov-file

